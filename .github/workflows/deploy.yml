# .github/workflows/deploy.yml
name: Deploy to Production

on:
  workflow_dispatch:
  repository_dispatch:
    types: [microcms-update]

permissions:
  contents: read
  packages: read

env:
  AWS_REGION: ap-northeast-1
  SITE_URL: https://kozennoki.com

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: "22"
          cache: "npm"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Start Nerine API
        run: |
          docker pull ghcr.io/kozennoki/nerine:latest
          docker run -d --name nerine \
            -p 8080:8080 \
            -e MICROCMS_API_KEY="${{ secrets.MICROCMS_API_KEY }}" \
            -e MICROCMS_SERVICE_ID="${{ secrets.MICROCMS_SERVICE_ID }}" \
            -e NERINE_API_KEY="${{ secrets.NERINE_API_KEY }}" \
            -e PORT=8080 \
            ghcr.io/kozennoki/nerine:latest

      - name: Wait for Nerine API
        run: |
          timeout 90 bash -c 'while ! curl -s http://localhost:8080/health >/dev/null; do
            sleep 3;
          done'

      - name: Install dependencies
        run: npm ci

      - name: Build Abelia
        run: npm run build:ci
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080
          NEXT_PUBLIC_API_KEY: ${{ secrets.NERINE_API_KEY }}
          NEXT_PUBLIC_GA_ID: ${{ secrets.GA_ID }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: build-output
          path: out/
          retention-days: 7

      - name: Deploy to S3
        run: |
          # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸï¼ˆå‰Šé™¤ã‚ã‚Šï¼‰
          aws s3 sync out/ s3://${{ secrets.S3_BUCKET }}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable"

          # çŸ­æœŸé–“ç”¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¸Šæ›¸ã
          aws s3 cp s3://${{ secrets.S3_BUCKET }}/ s3://${{ secrets.S3_BUCKET }}/ \
            --recursive \
            --exclude "*" \
            --include "*.html" \
            --include "sitemap.xml" \
            --include "robots.txt" \
            --cache-control "public,max-age=3600,must-revalidate" \
            --metadata-directive REPLACE

      - name: Show Nerine API logs on failure
        if: failure()
        run: |
          echo "ğŸ” Nerine API logs:"
          docker logs nerine || echo "No logs available"

      - name: Cleanup
        if: always()
        run: |
          docker stop nerine 2>/dev/null || true
          docker rm nerine 2>/dev/null || true

      - name: Deploy Summary
        run: |
          echo "ğŸ‰ Deploy completed successfully!"
          echo "ğŸŒ Site URL: ${{ env.SITE_URL }}"
          echo "â±ï¸  CloudFront cache invalidation in progress (3-5 minutes)"
