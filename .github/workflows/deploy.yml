# .github/workflows/deploy.yml
name: Deploy to Production

on:
  workflow_dispatch:
  repository_dispatch:
    types: [microcms-update]

permissions:
  contents: read
  packages: read

env:
  AWS_REGION: ap-northeast-1
  SITE_URL: https://kozennoki.com

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: "22"
          cache: "npm"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Start Nerine API
        run: |
          docker pull ghcr.io/kozennoki/nerine:latest
          docker run -d --name nerine \
            -p 8080:8080 \
            -e MICROCMS_API_KEY="${{ secrets.MICROCMS_API_KEY }}" \
            -e MICROCMS_SERVICE_ID="${{ secrets.MICROCMS_SERVICE_ID }}" \
            -e NERINE_API_KEY="${{ secrets.NERINE_API_KEY }}" \
            -e PORT=8080 \
            ghcr.io/kozennoki/nerine:latest

      - name: Wait for Nerine API
        run: |
          timeout 90 bash -c 'while ! curl -s http://localhost:8080/health >/dev/null; do
            sleep 3;
          done'

      - name: Install dependencies
        run: npm ci

      - name: Build Abelia
        run: npm run build:ci
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: http://localhost:8080/api/v1
          NEXT_PUBLIC_API_KEY: ${{ secrets.NERINE_API_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ env.SITE_URL }}

      - name: Deploy to S3
        run: |
          # é™çš„ã‚¢ã‚»ãƒƒãƒˆï¼ˆé•·æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
          aws s3 sync out/ s3://${{ secrets.S3_BUCKET }}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html" \
            --exclude "sitemap.xml" \
            --exclude "robots.txt"

          # HTMLãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆçŸ­æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
          aws s3 sync out/ s3://${{ secrets.S3_BUCKET }}/ \
            --cache-control "public,max-age=3600,must-revalidate" \
            --exclude "*" \
            --include "*.html" \
            --include "sitemap.xml" \
            --include "robots.txt"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Show Nerine API logs on failure
        if: failure()
        run: |
          echo "ğŸ” Nerine API logs:"
          docker logs nerine || echo "No logs available"

      - name: Cleanup
        if: always()
        run: |
          docker stop nerine 2>/dev/null || true
          docker rm nerine 2>/dev/null || true

      - name: Deploy Summary
        run: |
          echo "ğŸ‰ Deploy completed successfully!"
          echo "ğŸŒ Site URL: ${{ env.SITE_URL }}"
          echo "â±ï¸  CloudFront cache invalidation in progress (3-5 minutes)"
